### ELB - Elastic Load Balancer


- Managed Load balancer
- Health checks : port and route
- 4 Kinds
    - CLB - Classic Load Balancer (deprecated - not in exam)
    - ALB - Application Load Balancer
        - HTTP(S), Websockets
    - NLP - Network Load Balancer (high performances)
        - TCP, TLS, UDP (Layer 4)
    - GLP - Gateway Load Balancer (no in exam according to Cloud guru)
        - IP Protocol (Layer 3)
- Some can be setup as Internal / External (internet-facing = requests from internet directly to targets)
- Load balancer SG (ex. 80 & 443) and App SG (ex. 80)
    - In App SG can add "allow traffic only from Load Balancer" rule by adding its SG rule
- Can route across AZ 

#### ALB

- Operates on Layer 7
- HTTP(S), Websockets
  - on HTTPS at least one SSL/TLS server certificate is required
- ALB has listener (to ports) and each listener has rules
- Routing tables (rules) to Target Groups (or redirect URL or fixed response)
    - Based on URL Path
    - Based on Hostname
    - Based on Query/Headers
- LB Rules can have priorities (from 1 highest to 50000)
- ALB can route to multiple TG (target groups)
- Target groups
    - EC2 instances - can be managed by Auto Scaling Froup - HTTP
    - ECS tasks - managed by ECS - HTTP
    - Lambda functions (HTTP request translated to JSON Event)
    - IP Addresses (private IPs)
- Health checks are at the target group level
- Notes :
    - Fixed hostname for ALB
    - X-Forwared-For assigned
    - Error 504 Gateway timeout -> LB OK but service is down (servers, db, etc.)
- Note : In AWS, an Application Load Balancer (ALB) typically uses dynamic IP addressing. 
  If you need your ALB to have a static IP address, you can achieve this by using a Network Load Balancer (NLB). 
  You can associate the NLB with an Elastic IP address, which is a static, public IPv4 address, and then register your ALB as a target of the NLB.
#### NLB

- Operates on Layer 4
- TCP, TLS, UDP (Layer 4) - Any port 
- Handle millions of request / second
- Less latency
- NLB has one static IP per AZ and supports assigning Elastic IP
- Target Groups : EC2 Instances, IP Addresses (private), ALB
- Health check : TCP, HTTP and HTTPS
- Can decrypt traffic but have to install the certificate in the NLB

#### GLB

- Usage : Firewalls, Intrusion detection, Deep Packet Inspection, payload manipulation, etc.
- Another example : GENEVE Protocol on port 6081
- Traffic is routed to 3d party Target Group before accessing Application
- Combine 2 functions
    - Transparent Network Gateway
    - Load balancing

#### Sticky session - Session Affinity

- Available for CLB, ALB and NLB
- Uses Cookie
    - Custom Application based Cookies
        - Generated by the target
        - Can include any custom attributes required by the app
        - Cookie name must be specified individually for each target group
        - Reserved names : AWSALB, AWSALBAPP, AWSALBTG
    - Application cookie
        - AWSALBAPP named Cookie Generated by  the LB
    - Duration based Cookies
        - Generated by the LB and expires based on LB specification
        - Named AWSALB
- Caution to imbalance

#### Cross zone balancing

- Distribute traffic across AZ based on instance number into each
- ALB - enabled by default (no extra charges)
    - Can be disabled at target group level
- NLB - disabled by default (extra charges if enabled)

#### SSL Certificates

- One can manage certificates using ACM - AWS Certifite Manager
- Or create and upload your own certificates
- HTTPS (LB) Listener requires :
    - Default certificate
    - Optional list of certs (to support multi domain)
    - Client can use SNI - Server Name Indication
    - Can support Legacy SSL
- SNI - newer protocol that requires the client to indicate the hostname in initial SSL handshake
    - This solves the problem of multiple SSL certs in one server
    - Only works for ALB and NLB, CloudFront

#### Connection Draining (Deregistration)

- Named Deregistration Delay for ALB and NLB
- Time to complete in flight requests while the instance is de-registering or unhealthy
- Stop sending new requests to EC2 instance
- Between 1 to 3600 seconds (default to 300) - can be set to 0